---
interface Props {
  type?: 'blog' | 'news';
}

interface Item {
  id: number;
  slug: string;
  name: string;
}

const { type = 'blog' } = Astro.props;

let items: Item[] = [];
let basePath = '';

if (type === 'blog') {
  const uriType = import.meta.env.PUBLIC_API_WP_BLOG_TYPE;
  const reqUrlType = `?acf_format=standard&_fields=id,slug,name`;
  const responseType = await fetch(uriType + `${reqUrlType}`, { mode: "cors" });
  const categories = await responseType.json();
  
  items = categories.map((category) => ({
    id: category.id,
    slug: category.slug,
    name: category.name,
  }));
  basePath = '/blogs/category';
} else {
  const uriType = import.meta.env.PUBLIC_API_WP_NEWS_TYPE;
  const reqUrlType = `?acf_format=standard&_fields=id,slug,name`;
  const responseType = await fetch(uriType + `${reqUrlType}`, { mode: "cors" });
  const tags = await responseType.json();
  
  items = tags.map((tag) => ({
    id: tag.id,
    slug: tag.slug,
    name: tag.name,
  }));
  basePath = '/articles/tag';
}

// Ensure there's always an "others" entry (ชื่อไทย: 'อื่นๆ') when missing.
// Blogs may already include it; this avoids duplication and adds it for news.
if (!items.some((it) => it.slug === 'others')) {
  items.push({ id: -1, slug: 'others', name: 'อื่นๆ' });
}

// Normalize current pathname (handle trailing slashes) and compute "all" active state
// Use Astro.url.pathname (available in Astro component frontmatter)
const rawPathname = Astro.url && Astro.url.pathname ? Astro.url.pathname : '/';
const pathname = rawPathname === '/' ? '/' : rawPathname.replace(/\/+$/g, '');
const allPath = type === 'blog' ? '/blogs' : '/articles';
const allPathNorm = allPath.replace(/\/+$/g, '');
const allActive = pathname === allPathNorm || pathname.startsWith(`${allPathNorm}/page`);
---

<div class="flex justify-start border-b-2 border-b-blue-900 pb-4">
  <h2 class="text-24 md:text-30">เลือกหัวข้อที่คุณสนใจ</h2>
</div>
<ul class="mt-6">
  <li>
    <a
      href={type === 'blog' ? '/blogs' : '/articles'}
      class:list={[
        "text-24",
        allActive ? "text-blue-600 font-bold" : "text-gray-400"
      ]}
    >
      <h5>ทั้งหมด</h5>
    </a>
  </li>
  {
    items.map((item) => {
      const itemPath = `${basePath}/${item.slug}`;
      const itemPathNorm = itemPath.replace(/\/+$/g, '');
      const isActive = pathname === itemPathNorm || pathname.startsWith(`${itemPathNorm}/`);
      return (
        <li class="">
          <a
            href={itemPath}
            class:list={[
              "text-24",
              isActive ? "text-blue-600 font-bold" : "text-gray-400"
            ]}
          >
            <h5>{item.name}</h5>
          </a>
        </li>
      );
    })
  }
</ul>
