---
import AlumniListView from "../../../../../components/Alumni/AlumniListView.astro";
import { ALUMNI_PER_PAGE } from "../../../../../consts";
import { getLangFromUrl, useTranslations } from "../../../../../i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// ✅ ใช้ paginate ร่วมกับ flatMap เพื่อจัดการ URL ที่มีตัวแปร 2 ตัว ([generation] และ [page])
export async function getStaticPaths({ paginate }) {
  const alumniApi = import.meta.env.PUBLIC_API_WP_ALUMNI;
  const cateApi = import.meta.env.PUBLIC_API_WP_ALUMNI_GENERATION;

  // 1. ดึงข้อมูล Categories (รุ่น) ทั้งหมด
  const cateRes = await fetch(`${cateApi}?per_page=100`);
  const categories = await cateRes.json();

  // 2. ดึงข้อมูลศิษย์เก่า "ทั้งหมด"
  const alumniRes = await fetch(`${alumniApi}?per_page=100&_embed&acf_format=standard`);
  const allAlumni = await alumniRes.json();

  // 3. วนลูปทีละรุ่น และสร้างหน้า Pagination ของรุ่นนั้นๆ
  return categories.flatMap((cat) => {
    
    // กรองเอาเฉพาะศิษย์เก่าที่อยู่ในรุ่น (cat) นี้
    const alumniGens = allAlumni.filter((b) => {
      const tags = b.acf?.gen;
      if (!tags) return false;
      if (Array.isArray(tags)) return tags.some((tt) => tt?.slug === cat.slug);
      return tags?.slug === cat.slug;
    });

    // ให้ Astro ตัดแบ่งหน้าเฉพาะคนในรุ่นนี้
    return paginate(alumniGens, {
      params: { generation: cat.slug }, // ส่ง params ไปให้ URL [generation]
      pageSize: ALUMNI_PER_PAGE,
      props: { 
        genName: cat.name,
        genSlug: cat.slug,
        allAlumni: allAlumni // ส่งข้อมูลทุกคนไปเผื่อใช้หาเพื่อน (Mutual)
      },
    });
  });
}

// รับค่าที่ Astro จัดการตัดหน้ามาให้แล้ว (เติม as any กันขีดแดง)
const { page, genName, genSlug, allAlumni } = Astro.props as any;
---

<AlumniListView
  pageTitle={genName}
  pageDesc="รวมรายชื่อศิษย์เก่า" 
  breadcrumbsItems={[
    { label: "หน้าหลัก", href: "/" },
    { label: "ศิษย์เก่า", href: "/alumni" },
    { label: genName, href: `/alumni/generation/${genSlug}` },
    { label: `หน้า ${page.currentPage}` },
  ]}
  showIntroText={false} 
  allAlumni={allAlumni} 
  displayAlumni={page.data}
  currentPage={page.currentPage}
  totalPages={page.lastPage}
  paginationBaseUrl={`/alumni/generation/${genSlug}`} 
  emptyMessage={`ยังไม่มีข้อมูลใน ${genName}`}
/>