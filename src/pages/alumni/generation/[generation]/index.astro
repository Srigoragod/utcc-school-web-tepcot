---
import AlumniListView from "../../../../components/Alumni/AlumniListView.astro";
import { ALUMNI_PER_PAGE } from "../../../../consts";
import { getLangFromUrl, useTranslations } from "../../../../i18n/utils";
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

export async function getStaticPaths() {
  const alumniApi = import.meta.env.PUBLIC_API_WP_ALUMNI;
  const cateApi = import.meta.env.PUBLIC_API_WP_ALUMNI_GENERATION;

  // ✅ fetch all categories first
  const cateRes = await fetch(`${cateApi}?per_page=100`);
  const categories = await cateRes.json();

  // ✅ fetch all news once
  const alumniRes = await fetch(
    `${alumniApi}?per_page=100&_embed&acf_format=standard`,
  );
  const generation = await alumniRes.json();

  // ✅ build paths by gen slug (route param is [gen])
  const paths = categories.map((cat) => ({
    params: { generation: cat.slug },
    props: {
      generation,
      genSlug: cat.slug,
      genName: cat.name,
    },
  }));
  return paths;
}

const { generation = [], genSlug, genName } = Astro.props;
const currentPage = 1;

const alumniGens = generation.filter((b) => {
  const tags = b.acf?.gen;
  if (!tags) return false;
  if (Array.isArray(tags)) return tags.some((tt) => tt?.slug === genSlug);
  return tags?.slug === genSlug;
});

const totalPages = Math.ceil(alumniGens.length / ALUMNI_PER_PAGE);
const paginatedAlumni = alumniGens.slice(0, ALUMNI_PER_PAGE);
---

<AlumniListView
  pageTitle={genName}
  pageDesc="รวมรายชื่อศิษย์เก่า" 
  breadcrumbsItems={[
    { label: "หน้าหลัก", href: "/" },
    { label: "ศิษย์เก่า", href: "/alumni" },
    { label: genName },
  ]}
  showIntroText={false} 
  allAlumni={generation} 
  displayAlumni={paginatedAlumni}
  currentPage={currentPage}
  totalPages={totalPages}
  paginationBaseUrl={`/alumni/generation/${genSlug}`}
  emptyMessage={`ยังไม่มีข้อมูลใน ${genName}`}
/>